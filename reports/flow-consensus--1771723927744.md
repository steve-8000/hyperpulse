# Flow(Consensus) 운영 리포트

- 생성 시각: 2026-02-22T01:32:07.744Z
- RSS: v0.46.1-experimental-indexer.9
- 비교 기준(Base): 1651c1aa13e6d0ddd0fb569b0296963d465bd475
- 최신 커밋(Head): 2c4a94dade433e615fb70da1d86c2ae1c5514dd0

## 한줄 요약
이 커밋은 Flow의 이벤트 파서에서 ‘withdrawal vault’에 대한 deposit 이벤트를 처리하는 로직을 보강한 내용이다. 기존에는 deposit이 발생해도 해당 withdrawal‑vault의 잔액을 반영하지 않았으나, 새 로직은 "destIdx" 가 withdrawal‑vault 인 경우 그 vault의 tracked amount 를 증가시켜서 mint‑deposited 상황을 올바르게 반영한다. 이로써 중간 vault에 mint‑된 토큰이 deposit 될 때, 이후 child‑withdrawal 이 정상적으로 처리될 수 있게 된다.

이 변경은 테스트 코드에서 `MakeFTDepositedEvent` 호출 시 인자 순서에 1을 추가해 새 파라미터를 전달하도록 수정한 점이 특징이다. 이는 이벤트 생성 시 `isDeposit` 혹은 `isMinted` 같은 플래그를 전달하기 위함이며, 실제 파서 로직에 반영된다.


이로 인해 기존 API/JSON‑RPC 인터페이스에는 직접적인 변경은 없으나, 이벤트 파싱 로직이 바뀌면서 Archive Node가 기록하는 `fungible_token_transfer` 데이터에 미세한 차이가 발생할 수 있다.


### 핵심 로직 변경 포인트
1. `ft_group.go` 에서 deposit 이벤트가 withdrawal‑vault에 들어올 때, 해당 vault의 `withdrawals[destIdx].decoded.Amount` 를 증가시켜서 mint‑deposited 상황을 반영.
2. 테스트 코드에서 deposit 이벤트 생성 시 추가 인자(1)를 넣어 새 파라미터를 전달하도록 수정.

이 변경은 이벤트 파서가 중간 vault에 대한 mint‑deposited 상황을 올바르게 처리하도록 보강한 것으로, 운영자는 이 로직이 정상 동작하는지 모니터링 지표를 추가로 확인할 필요가 있다.



## 운영자 중요 체크
- 아카이브 노드 운영(보관/색인/동기화) 관련 변경 단서가 감지되었습니다.

## 주요 변경점
- ft_group.go에서 deposit 이벤트가 withdrawal‑vault에 들어올 때, 해당 vault의 tracked amount 를 증가시키는 로직 추가
- test 코드에서 MakeFTDepositedEvent 호출 시 인자에 1을 삽입해 새 파라미터 전달
- 이벤트 파서 로직에서 "destIdx" 가 withdrawal‑vault 인 경우를 처리하도록 수정

## RPC/API 영향
- 해당 사항 없음

## 아카이브 노드 영향
- 새 로직이 적용된 파서가 이벤트를 파싱할 때, 중간 vault에 deposit 이 발생하면 tracked amount 가 증가하도록 처리. 이는 Archive Node가 기록하는 `fungible_token_transfer` 데이터에 미세한 차이를 만들 수 있다. 재인덱싱 시 이 로직을 반영하도록 업데이트 필요

## 운영 액션 아이템
- 1. 테스트 케이스를 실행해 파서가 정상 동작하는지 확인
- 2. Archive Node 재인덱싱 시 새 로직을 반영하도록 파서 버전 업데이트
- 3. 이벤트 파서가 중간 vault에 deposit 시 tracked amount 를 올바르게 반영하는지 모니터링 지표 추가

## 마이그레이션 체크리스트
- 1. 새 로직이 적용된 파서 버전으로 배포
- 2. 테스트 케이스가 정상 동작하는지 CI에서 확인
- 3. Archive Node 재인덱싱 시 새 로직 반영 여부 검증

## 위험/주의 사항
- 위험 요소 없음

## 근거(Evidence)
- commit 2c4a94dade: "fix bug in event parsing"
- diff snippet showing addition of '1' parameter to MakeFTDepositedEvent calls in multiple test files
- diff snippet showing new logic in ft_group.go: if destIdx, destOk := g.withdrawalByUUID[decoded.ToUUID]; destOk { g.withdrawals[destIdx].decoded.Amount += decoded.Amount }

## 운영 메모
- 추가 메모 없음

## 원문 커밋 내용
### Commit Log
```text
2c4a94dade fix bug in event parsing
```

